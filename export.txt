// ========================================
// –ß–ê–°–¢–¨ 3: –≠–ö–°–ü–û–†–¢ –†–ï–ó–£–õ–¨–¢–ê–¢–û–í
// ========================================
// PDF —ç–∫—Å–ø–æ—Ä—Ç, —Å–æ—Ü—Å–µ—Ç–∏, –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

// ===== 1. –î–æ–±–∞–≤—å—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫—É jsPDF –≤ <head> =====
// <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

// ===== 2. –î–æ–±–∞–≤—å—Ç–µ –∫–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã =====
// –í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç HTML –≤ –±–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (#result):
/*
<div class="export-buttons" style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap;">
  <button id="exportPDF" class="btn primary">üìÑ –°–∫–∞—á–∞—Ç—å PDF</button>
  <button id="shareVK" class="btn">üì± VK</button>
  <button id="shareTelegram" class="btn">‚úàÔ∏è Telegram</button>
  <button id="shareWhatsApp" class="btn">üí¨ WhatsApp</button>
  <button id="copyResult" class="btn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
</div>
*/

// ===== 3. CSS –¥–ª—è –∫–Ω–æ–ø–æ–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞ =====
const exportStyles = `
.export-buttons {
  margin-top: 16px;
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.export-buttons .btn {
  padding: 10px 16px;
  border-radius: 8px;
  border: none;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  background: var(--card);
  color: var(--text);
  border: 1px solid rgba(0,0,0,0.1);
}
.export-buttons .btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.export-buttons .btn.primary {
  background: var(--accent-2);
  color: white;
  border: none;
}
.copy-notification {
  position: fixed;
  top: 100px;
  right: 20px;
  background: var(--success);
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  z-index: 150;
  animation: slideIn 0.3s ease-out;
}
@keyframes slideIn {
  from { transform: translateX(400px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}
`;

// –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏
const styleSheet = document.createElement('style');
styleSheet.textContent = exportStyles;
document.head.appendChild(styleSheet);

// ===== 4. –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ =====
let currentResult = null;

// ===== 5. –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ =====
function generateResultText(result) {
  return `üß† –ú–û–ô –†–ï–ó–£–õ–¨–¢–ê–¢ –§–ò–õ–û–°–û–§–°–ö–û–ì–û –¢–ï–°–¢–ê

üìñ –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è: ${result.philosophy}
üéØ –ü–æ–¥—Ç–∏–ø: ${result.subtype}
üìä –ò–Ω–¥–µ–∫—Å —Å–º—ã—Å–ª–æ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏: ${result.meaningIndex}/100

${result.description}

–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç: ${window.location.href}`;
}

// ===== 6. –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF =====
async function exportToPDF(result) {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ jsPDF
    if (typeof window.jspdf === 'undefined') {
      alert('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ PDF –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –î–æ–±–∞–≤—å—Ç–µ jsPDF –≤ <head>.');
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à—Ä–∏—Ñ—Ç–æ–≤ –∏ —Ü–≤–µ—Ç–æ–≤
    const primaryColor = [43, 123, 228];
    const textColor = [34, 34, 34];
    
    let y = 20;
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
    doc.setFontSize(24);
    doc.setTextColor(...primaryColor);
    doc.text('–§–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π —Ç–µ—Å—Ç', 105, y, { align: 'center' });
    
    y += 15;
    doc.setFontSize(12);
    doc.setTextColor(...textColor);
    doc.text('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 105, y, { align: 'center' });
    
    y += 20;
    
    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è
    doc.setFontSize(14);
    doc.setTextColor(...primaryColor);
    doc.text('–û—Å–Ω–æ–≤–Ω–∞—è —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è:', 20, y);
    y += 8;
    doc.setFontSize(12);
    doc.setTextColor(...textColor);
    doc.text(result.philosophy, 20, y);
    
    y += 15;
    
    // –ü–æ–¥—Ç–∏–ø
    doc.setFontSize(14);
    doc.setTextColor(...primaryColor);
    doc.text('–ü–æ–¥—Ç–∏–ø:', 20, y);
    y += 8;
    doc.setFontSize(12);
    doc.setTextColor(...textColor);
    doc.text(result.subtype, 20, y);
    
    y += 15;
    
    // –ò–Ω–¥–µ–∫—Å —Å–º—ã—Å–ª–æ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
    doc.setFontSize(14);
    doc.setTextColor(...primaryColor);
    doc.text('–ò–Ω–¥–µ–∫—Å —Å–º—ã—Å–ª–æ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏:', 20, y);
    y += 8;
    doc.setFontSize(12);
    doc.setTextColor(...textColor);
    doc.text(`${result.meaningIndex}/100`, 20, y);
    
    // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
    y += 5;
    doc.setFillColor(233, 238, 248);
    doc.rect(20, y, 170, 6, 'F');
    doc.setFillColor(...primaryColor);
    doc.rect(20, y, (result.meaningIndex / 100) * 170, 6, 'F');
    
    y += 15;
    
    // –û–ø–∏—Å–∞–Ω–∏–µ
    doc.setFontSize(14);
    doc.setTextColor(...primaryColor);
    doc.text('–û–ø–∏—Å–∞–Ω–∏–µ:', 20, y);
    y += 8;
    doc.setFontSize(11);
    doc.setTextColor(...textColor);
    
    // –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —Å—Ç—Ä–æ–∫–∏
    const splitDescription = doc.splitTextToSize(result.description, 170);
    doc.text(splitDescription, 20, y);
    
    y += splitDescription.length * 6 + 15;
    
    // –î–µ–º–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    if (result.demographics) {
      if (y > 250) {
        doc.addPage();
        y = 20;
      }
      
      doc.setFontSize(14);
      doc.setTextColor(...primaryColor);
      doc.text('–î–µ–º–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ:', 20, y);
      y += 8;
      doc.setFontSize(11);
      doc.setTextColor(...textColor);
      
      for (const [key, value] of Object.entries(result.demographics)) {
        if (y > 280) {
          doc.addPage();
          y = 20;
        }
        doc.text(`${key}: ${value}`, 20, y);
        y += 6;
      }
    }
    
    // –§—É—Ç–µ—Ä
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      doc.setFontSize(9);
      doc.setTextColor(128, 128, 128);
      doc.text(`–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${i} –∏–∑ ${pageCount}`, 105, 285, { align: 'center' });
      doc.text(`–§–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π —Ç–µ—Å—Ç ‚Ä¢ ${window.location.hostname}`, 105, 290, { align: 'center' });
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    const filename = `–§–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π_—Ç–µ—Å—Ç_${result.philosophy.replace(/\s+/g, '_')}.pdf`;
    doc.save(filename);
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ
    if (window.philosophyTestAnalytics) {
      window.philosophyTestAnalytics.trackExport('pdf');
    }
    
    showNotification('PDF —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PDF:', error);
    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PDF. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
  }
}

// ===== 7. –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö =====
function shareToVK(result) {
  const text = generateResultText(result);
  const url = encodeURIComponent(window.location.href);
  const title = encodeURIComponent('–ú–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∞');
  window.open(`https://vk.com/share.php?url=${url}&title=${title}`, '_blank', 'width=600,height=400');
  
  if (window.philosophyTestAnalytics) {
    window.philosophyTestAnalytics.trackExport('vk');
  }
}

function shareToTelegram(result) {
  const text = encodeURIComponent(generateResultText(result));
  window.open(`https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${text}`, '_blank');
  
  if (window.philosophyTestAnalytics) {
    window.philosophyTestAnalytics.trackExport('telegram');
  }
}

function shareToWhatsApp(result) {
  const text = encodeURIComponent(generateResultText(result));
  window.open(`https://wa.me/?text=${text}`, '_blank');
  
  if (window.philosophyTestAnalytics) {
    window.philosophyTestAnalytics.trackExport('whatsapp');
  }
}

// ===== 8. –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç =====
async function copyResultToClipboard(result) {
  const text = generateResultText(result);
  
  try {
    if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(text);
      showNotification('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
    } else {
      // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        document.execCommand('copy');
        showNotification('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
      } catch (err) {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç');
      }
      
      document.body.removeChild(textArea);
    }
    
    if (window.philosophyTestAnalytics) {
      window.philosophyTestAnalytics.trackExport('copy');
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏:', error);
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç');
  }
}

// ===== 9. –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ =====
function showNotification(message) {
  const notification = document.createElement('div');
  notification.className = 'copy-notification';
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideIn 0.3s ease-out reverse';
    setTimeout(() => notification.remove(), 300);
  }, 2000);
}

// ===== 10. –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞ =====
function addExportButtons(resultElement, result) {
  currentResult = result;
  
  const buttonsHTML = `
    <div class="export-buttons">
      <button id="exportPDF" class="btn primary">üìÑ –°–∫–∞—á–∞—Ç—å PDF</button>
      <button id="shareVK" class="btn">üì± VK</button>
      <button id="shareTelegram" class="btn">‚úàÔ∏è Telegram</button>
      <button id="shareWhatsApp" class="btn">üí¨ WhatsApp</button>
      <button id="copyResult" class="btn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
  `;
  
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = buttonsHTML;
  resultElement.appendChild(tempDiv.firstElementChild);
  
  // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
  document.getElementById('exportPDF').addEventListener('click', () => exportToPDF(result));
  document.getElementById('shareVK').addEventListener('click', () => shareToVK(result));
  document.getElementById('shareTelegram').addEventListener('click', () => shareToTelegram(result));
  document.getElementById('shareWhatsApp').addEventListener('click', () => shareToWhatsApp(result));
  document.getElementById('copyResult').addEventListener('click', () => copyResultToClipboard(result));
}

// ===== 11. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ñ—É–Ω–∫—Ü–∏–µ–π calculate() =====
/*
–ü–†–ò–ú–ï–† –ò–ù–¢–ï–ì–†–ê–¶–ò–ò:

function calculate() {
  // ... –≤–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ —Ä–∞—Å—á–µ—Ç–∞ ...
  
  const result = {
    philosophy: main,
    subtype: sub,
    meaningIndex: mi,
    description: longDesc[top[0]] || '',
    demographics: {
      '–í–æ–∑—Ä–∞—Å—Ç': fd.get('age') || '–ù–µ —É–∫–∞–∑–∞–Ω',
      '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ': fd.get('education') || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
      '–ü–æ–ª': fd.get('gender') || '–ù–µ —É–∫–∞–∑–∞–Ω',
      '–ù–∞—Å–µ–ª–µ–Ω–∏–µ': fd.get('population') || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'
    }
  };
  
  // ... –ø–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ HTML ...
  
  // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
  const resultEl = document.getElementById('result');
  addExportButtons(resultEl, result);
  
  // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
  if (window.philosophyTestAnalytics) {
    window.philosophyTestAnalytics.trackTestComplete(result);
  }
}
*/

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏
window.philosophyTestExport = {
  exportToPDF,
  shareToVK,
  shareToTelegram,
  shareToWhatsApp,
  copyResultToClipboard,
  addExportButtons
};

console.log('üì§ –ú–æ–¥—É–ª—å —ç–∫—Å–ø–æ—Ä—Ç–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');